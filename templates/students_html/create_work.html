<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建作品 - 用户信息管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        .page-container {
            max-width: 800px;
            margin: 50px auto;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>创建作品</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('portfolio') }}" class="btn btn-secondary">返回作品集</a>
                <a href="javascript:history.back()" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>返回</a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">返回首页</a>
            </div>
        </div>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">作品基本信息</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">作品名称</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="theme" class="form-label">作品主题</label>
                        <textarea class="form-control" id="theme" name="theme" rows="3" placeholder="请描述作品的主题和内容..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <h6>功能组管理</h6>
                        <div class="d-flex gap-2 mb-3">
                            <input type="text" class="form-control" id="newGroup" placeholder="输入功能组名称">
                            <button type="button" class="btn btn-primary" onclick="addGroup()">添加功能组</button>
                        </div>
                        <div id="groupsList">
                            <!-- 功能组将动态添加到这里 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>文件上传</h6>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="fileUpload" multiple accept=".jpg,.jpeg,.png,.pdf">
                            <small class="form-text text-muted">支持上传jpg、png、PDF格式的文件</small>
                        </div>
                        <div id="filesList">
                            <!-- 选择的文件将动态添加到这里 -->
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for("portfolio") }}'">取消</button>
                        <button type="submit" class="btn btn-primary">创建作品</button>
                    </div>
                </form>
                
                <script>
                    // 功能组管理
                    let groups = [];
                    let groupCounter = 1;
                    
                    function addGroup() {
                        const groupName = document.getElementById('newGroup').value.trim();
                        if (!groupName) {
                            alert('请输入功能组名称');
                            return;
                        }
                        
                        const groupId = `group_${groupCounter++}`;
                        groups.push({ id: groupId, name: groupName });
                        
                        // 更新功能组列表
                        updateGroupsList();
                        // 更新文件列表中的功能组选择
                        updateFileGroupSelects();
                        
                        // 清空输入框
                        document.getElementById('newGroup').value = '';
                    }
                    
                    function removeGroup(groupId) {
                        groups = groups.filter(group => group.id !== groupId);
                        updateGroupsList();
                        updateFileGroupSelects();
                    }
                    
                    function updateGroupsList() {
                        const groupsList = document.getElementById('groupsList');
                        groupsList.innerHTML = '';
                        
                        groups.forEach(group => {
                            const groupItem = document.createElement('div');
                            groupItem.className = 'd-flex align-items-center gap-2 mb-2';
                            groupItem.innerHTML = `
                                <span class="badge bg-primary">${group.name}</span>
                                <input type="hidden" name="group_names" value="${group.name}">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeGroup('${group.id}')">删除</button>
                            `;
                            groupsList.appendChild(groupItem);
                        });
                    }
                    
                    // 文件上传管理
                    let selectedFiles = [];
                    
                    document.getElementById('fileUpload').addEventListener('change', function(e) {
                        const files = Array.from(e.target.files);
                        selectedFiles = [...selectedFiles, ...files];
                        updateFilesList();
                        e.target.value = ''; // 允许重新选择相同的文件
                    });
                    
                    function removeFile(index) {
                        selectedFiles.splice(index, 1);
                        updateFilesList();
                    }
                    
                    function updateFilesList() {
                        const filesList = document.getElementById('filesList');
                        filesList.innerHTML = '';
                        
                        selectedFiles.forEach((file, index) => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'd-flex align-items-center gap-2 mb-2';
                            
                            // 创建文件信息和选择控件
                            fileItem.innerHTML = `
                                <span class="file-name">${file.name}</span>
                                <select class="form-select form-select-sm group-select" name="file_group_${index}">
                                    ${groups.map(group => `<option value="${group.name}">${group.name}</option>`).join('')}
                                </select>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeFile(${index})">删除</button>
                            `;
                            
                            // 创建隐藏的文件输入，用于表单提交
                            const fileInput = document.createElement('input');
                            fileInput.type = 'hidden';
                            fileInput.name = `file_names_${index}`;
                            fileInput.value = file.name;
                            fileItem.appendChild(fileInput);
                            
                            filesList.appendChild(fileItem);
                        });
                    }
                    
                    function updateFileGroupSelects() {
                        const selects = document.querySelectorAll('.group-select');
                        selects.forEach(select => {
                            const currentValue = select.value;
                            select.innerHTML = groups.map(group => `<option value="${group.name}">${group.name}</option>`).join('');
                            select.value = currentValue;
                        });
                    }
                    
                    // 表单提交前的处理
                    document.querySelector('form').addEventListener('submit', function(e) {
                        // 创建FormData对象，添加文件和其他表单数据
                        const formData = new FormData(this);
                        
                        // 添加文件到FormData
                        selectedFiles.forEach((file, index) => {
                            formData.append('files', file);
                            // 获取对应的功能组
                            const groupSelect = document.querySelector(`[name="file_group_${index}"]`);
                            if (groupSelect) {
                                formData.append(`file_group_${index}`, groupSelect.value);
                            }
                        });
                        
                        // 清空原始表单，使用FormData提交
                        e.preventDefault();
                        
                        // 创建新的表单提交
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', this.action, true);
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                // 页面跳转
                                window.location.href = xhr.responseURL;
                            }
                        };
                        xhr.send(formData);
                    });
                </script>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>